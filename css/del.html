<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibTeX ç»ˆææ ¼å¼åŒ–å·¥å…·</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --border: #cbd5e1; --text: #334155; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .layout { max-width: 1400px; margin: 0 auto; display: flex; gap: 20px; flex-wrap: wrap; }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel { flex: 1; min-width: 300px; background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid var(--border); height: fit-content; }
        .settings-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .settings-section:last-child { border-bottom: none; }
        h2 { margin-top: 0; font-size: 1.2rem; color: #1e293b; display: flex; justify-content: space-between; align-items: center; }
        h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; color: #475569; }
        
        /* æ§ä»¶æ ·å¼ */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .checkbox-label { font-size: 0.85rem; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        input[type="text"], textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: "SFMono-Regular", Consolas, monospace; font-size: 13px; margin-top: 5px; }
        textarea:focus, input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        textarea { resize: vertical; }
        
        /* å·¥ä½œåŒº */
        .workspace { flex: 2; min-width: 400px; display: flex; flex-direction: column; gap: 20px; }
        .editor-container { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .editor-container textarea { min-height: 250px; }
        label.area-label { font-weight: 600; color: #1e293b; }
        
        .actions { display: flex; gap: 10px; align-items: center; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #64748b; }
        
        /* Tabs æ ·å¼ */
        .tabs { display: flex; gap: 5px; border-bottom: 1px solid var(--border); margin-bottom: -1px; }
        .tab-btn { background: transparent; color: #64748b; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; padding: 8px 16px; cursor: pointer; font-size: 0.9rem; }
        .tab-btn:hover { color: var(--primary); background: #f1f5f9; }
        .tab-btn.active { background: var(--surface); color: var(--primary); border-color: var(--border); border-bottom-color: var(--surface); font-weight: 600; position: relative; top: 1px; }

        /* GitHub Link */
        .github-link { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 8px; background-color: #24292e; color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 100; }
        .github-link:hover { background-color: #333; transform: translateY(-2px); }
        .github-link svg { fill: white; }
        @media (max-width: 600px) { .github-link span { display: none; } .github-link { padding: 8px; border-radius: 50%; } }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<a href="https://github.com/ylhz/bibtex-cleaner" target="_blank" class="github-link">
    <svg height="20" width="20" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
    <span>Star me</span>
</a>

<div class="layout">
    <aside class="settings-panel">
        <div class="settings-section">
            <h2>âš™ï¸ é…ç½® <button class="secondary" style="padding:4px 8px;font-size:12px;" onclick="resetDefaults()">é‡ç½®</button></h2>
        </div>
        <div class="settings-section">
            <h3>1. ä¿ç•™å­—æ®µ (BibTeX Only)</h3>
            <div class="checkbox-grid" id="fields-container"></div>
        </div>
        <div class="settings-section">
            <h3>2. ç´¢å¼•æ ¼å¼ (Citation Key)</h3>
            <input type="text" id="id-format" value="[Auth][Year][Title][Venue]">
        </div>
        <div class="settings-section" style="border-bottom:none;">
            <h3>3. ä¼šè®®/æœŸåˆŠåæ˜ å°„</h3>
            <textarea id="mapping-rules" spellcheck="false" style="min-height:150px;"></textarea>
        </div>
    </aside>

    <main class="workspace">
        <div class="editor-container">
            <label class="area-label">è¾“å…¥ BibTeX:</label>
            <textarea id="input" placeholder="ç²˜è´´å†…å®¹..."></textarea>
        </div>

        <div class="actions">
            <button onclick="runConversion()">âš¡ å¼€å§‹è½¬æ¢</button>
            <button class="secondary" onclick="copyResult()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
        </div>

        <div class="editor-container">
            <div style="display:flex; justify-content:space-between; align-items:end;">
                <label class="area-label">è¾“å‡ºç»“æœ:</label>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('bibtex')">BibTeX</button>
                    <button class="tab-btn" onclick="switchTab('mla')">MLA</button>
                    <button class="tab-btn" onclick="switchTab('gbt')">GB/T 7714</button>
                </div>
            </div>
            <textarea id="output" readonly placeholder="ç»“æœ..."></textarea>
        </div>
    </main>
</div>

<div id="toast" class="toast">å·²å¤åˆ¶</div>

<script>
// ================= å¸¸é‡é…ç½® =================
const DEFAULT_FIELDS = ['author', 'title', 'booktitle', 'journal', 'year', 'pages', 'volume', 'number', 'doi'];
const ALL_FIELDS = ['author', 'title', 'booktitle', 'journal', 'year', 'pages', 'volume', 'number', 'doi', 'url', 'eprint', 'publisher', 'editor', 'month'];
const DEFAULT_MAPPINGS = `CVPRW|CVPR.*Workshop => CVPRW
ICLRW|ICLR.*Workshop => ICLRW
CVPR|Computer Vision and Pattern Recognition => CVPR
ICCV|International Conference on Computer Vision => ICCV
ECCV|European Conference on Computer Vision => ECCV
NeurIPS|NIPS|Neural Information Processing Systems => NIPS
ICML|International Conference on Machine Learning => ICML
ICLR|International Conference on Learning Representations => ICLR
AAAI|Association for the Advancement of Artificial Intelligence => AAAI
IJCAI|International Joint Conference on Artificial Intelligence => IJCAI
ACM MM|Multimedia => ACMMM
TPAMI|Pattern Analysis and Machine Intelligence => PAMI
IJCV|International Journal of Computer Vision => IJCV
TIP|Transactions on Image Processing => TIP`;

const IGNORE_TITLE_WORDS = new Set(['the', 'a', 'an', 'on', 'in', 'of', 'for', 'and', 'with', 'via']);

// å…¨å±€å˜é‡å­˜å‚¨å¤„ç†åçš„æ•°æ®
let CURRENT_DATA = [];
let CURRENT_TAB = 'bibtex';

// ================= åˆå§‹åŒ– =================
window.onload = () => {
    renderFields();
    loadSettings();
};

function renderFields() {
    const container = document.getElementById('fields-container');
    container.innerHTML = '';
    ALL_FIELDS.forEach(f => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        label.innerHTML = `<input type="checkbox" id="chk-${f}" value="${f}"> ${f}`;
        container.appendChild(label);
    });
}

function loadSettings() {
    const fields = JSON.parse(localStorage.getItem('bib-fields')) || DEFAULT_FIELDS;
    ALL_FIELDS.forEach(f => { document.getElementById(`chk-${f}`).checked = fields.includes(f); });
    document.getElementById('id-format').value = localStorage.getItem('bib-format') || "[Auth][Year][Title][Venue]";
    document.getElementById('mapping-rules').value = localStorage.getItem('bib-mappings') || DEFAULT_MAPPINGS;
}

function saveSettings() {
    const fields = Array.from(document.querySelectorAll('#fields-container input:checked')).map(c => c.value);
    localStorage.setItem('bib-fields', JSON.stringify(fields));
    localStorage.setItem('bib-format', document.getElementById('id-format').value);
    localStorage.setItem('bib-mappings', document.getElementById('mapping-rules').value);
}

function resetDefaults() {
    if(confirm('æ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿ')) {
        localStorage.clear();
        loadSettings();
    }
}

// ================= æ ¸å¿ƒé€»è¾‘ =================

// 1. è§£æè§„åˆ™
function parseRules(text) {
    return text.split('\n').filter(l => l.trim() && !l.startsWith('#')).map(l => {
        const [reg, abbr] = l.split('=>');
        return (reg && abbr) ? { regex: new RegExp(reg.trim(), 'i'), abbr: abbr.trim() } : null;
    }).filter(x => x);
}

// 2. BibTeX è§£æ
function parseBibtex(input) {
    const entries = [];
    const entryRegex = /@(\w+)\s*\{([^,]*),([\s\S]*?)(?=@\w+|\s*$)/g;
    let match;
    while ((match = entryRegex.exec(input))) {
        const type = match[1].toLowerCase();
        const fields = {};
        const fieldRegex = /(\w+)\s*=\s*[\{"]([\s\S]*?)[\}"](?=\s*,|\s*$)|(\w+)\s*=\s*(\d+)/g;
        let fMatch;
        while ((fMatch = fieldRegex.exec(match[3]))) {
            const k = (fMatch[1]||fMatch[3]).toLowerCase();
            fields[k] = (fMatch[2]||fMatch[4]).replace(/\s+/g, ' ').trim();
        }
        entries.push({ type, fields, rawType: match[1] }); // rawTypeç”¨äºMLAåˆ¤æ–­
    }
    return entries;
}

// 3. å¤„ç†æ•°æ® (Clean & Rename)
function runConversion() {
    saveSettings();
    const input = document.getElementById('input').value;
    const mappings = parseRules(document.getElementById('mapping-rules').value);
    const idFormat = document.getElementById('id-format').value;
    const keepFields = Array.from(document.querySelectorAll('#fields-container input:checked')).map(c => c.value);

    let entries = parseBibtex(input);

    CURRENT_DATA = entries.map(entry => {
        const newEntry = { type: entry.rawType, fields: {} }; // ä¿ç•™åŸå§‹å¤§å°å†™ç±»å‹ä¾›BibTeXè¾“å‡º
        
        // ç­›é€‰å­—æ®µ (ä»…å¯¹ BibTeX è¾“å‡ºæœ‰æ•ˆï¼ŒMLA/GBT è¿˜æ˜¯ç”¨å…¨éƒ¨å¯ç”¨ä¿¡æ¯æ¯”è¾ƒå¥½ï¼Œè¿™é‡Œæˆ‘ä»¬å­˜å…¨éƒ¨ä¿¡æ¯ï¼Œè¾“å‡ºæ—¶ç­›é€‰)
        // ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨ newEntry.fields é‡Œå­˜å¤„ç†è¿‡çš„æ ¸å¿ƒæ•°æ®
        // ä½†ä¸ºäº† Citation ç”Ÿæˆï¼Œæˆ‘ä»¬éœ€è¦å…¨éƒ¨æ•°æ®ï¼Œæ‰€ä»¥å…ˆæŠŠå¤„ç†åçš„æ•°æ®å­˜å¥½
        
        // --- æ˜ å°„ä¼šè®®å ---
        let venueFull = entry.fields['booktitle'] || entry.fields['journal'] || "";
        let venueAbbr = "CONF";
        let found = false;
        
        if (venueFull) {
            for (let rule of mappings) {
                if (rule.regex.test(venueFull)) {
                    venueFull = rule.abbr; // æ›¿æ¢ä¸ºç¼©å†™
                    venueAbbr = rule.abbr;
                    found = true;
                    break;
                }
            }
            if (!found) {
                let simple = venueFull.replace(/[^{}\w\s]/g, "");
                venueAbbr = simple.split(/\s+/)[0] || "CONF";
            }
        }
        
        // å°†å¤„ç†åçš„ä¼šè®®åå›å†™ (æ³¨æ„ï¼šè¿™é‡Œç›´æ¥ä¿®æ”¹äº†æ•°æ®æºï¼Œç”¨äºåç»­è¾“å‡º)
        if (entry.fields['booktitle']) entry.fields['booktitle'] = venueFull;
        if (entry.fields['journal']) entry.fields['journal'] = venueFull;
        // å¦‚æœ booktitle å˜æˆäº†ç¼©å†™ï¼Œä¸”æ²¡æœ‰ journalï¼Œæœ‰äº›å¼•ç”¨æ ¼å¼å¯èƒ½éœ€è¦åŒºåˆ†

        // --- ç”Ÿæˆ ID ---
        let authors = (entry.fields['author'] || "Unknown").split(/\s+and\s+/);
        let firstAuth = authors[0].trim();
        let authLast = firstAuth.includes(',') ? firstAuth.split(',')[0] : firstAuth.split(/\s+/).pop();
        authLast = authLast.replace(/\W+/g, "");
        
        let year = entry.fields['year'] || "0000";
        
        let titleWord = "Untitled";
        if (entry.fields['title']) {
            let clean = entry.fields['title'].replace(/[\{\}]/g, "").replace(/[^\w\s]/g, "");
            let words = clean.split(/\s+/);
            for (let w of words) {
                if (!IGNORE_TITLE_WORDS.has(w.toLowerCase())) { titleWord = w.charAt(0).toUpperCase() + w.slice(1); break; }
            }
        }

        newEntry.id = idFormat.replace("[Auth]", authLast).replace("[Year]", year).replace("[Title]", titleWord).replace("[Venue]", venueAbbr);
        
        // --- ä¿å­˜æ‰€æœ‰å¤„ç†åçš„å­—æ®µ (ç”¨äº BibTeX è¾“å‡ºçš„ç­›é€‰) ---
        // åŒæ—¶ä¿ç•™ä¸€ä»½å®Œæ•´æ•°æ®ç”¨äº MLA/GBT
        newEntry.fields = entry.fields; 
        newEntry.keepFields = keepFields; // è®°å½•ç”¨æˆ·æƒ³åœ¨ BibTeX ä¸­ä¿ç•™çš„å­—æ®µ
        
        return newEntry;
    });

    CURRENT_DATA.sort((a, b) => a.id.localeCompare(b.id));
    updateOutput();
}

// ================= è¾“å‡ºæ ¼å¼åŒ–é€»è¾‘ =================

function switchTab(tab) {
    CURRENT_TAB = tab;
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[['bibtex','mla','gbt'].indexOf(tab)].classList.add('active');
    updateOutput();
}

function updateOutput() {
    if (!CURRENT_DATA || CURRENT_DATA.length === 0) {
        document.getElementById('output').value = "";
        return;
    }

    let result = "";
    
    if (CURRENT_TAB === 'bibtex') {
        result = toBibTeX(CURRENT_DATA);
    } else if (CURRENT_TAB === 'mla') {
        result = toMLA(CURRENT_DATA);
    } else if (CURRENT_TAB === 'gbt') {
        result = toGBT(CURRENT_DATA);
    }
    
    document.getElementById('output').value = result;
}

// æ ¼å¼ 1: BibTeX
function toBibTeX(data) {
    let str = "";
    data.forEach(e => {
        str += `@${e.type}{${e.id},\n`;
        // åªè¾“å‡ºç”¨æˆ·å‹¾é€‰çš„å­—æ®µ
        e.keepFields.forEach(k => {
            if (e.fields[k]) {
                str += `  ${k.padEnd(12)} = {${e.fields[k]}},\n`;
            }
        });
        str = str.replace(/,\n$/, "\n");
        str += `}\n\n`;
    });
    return str;
}

// æ ¼å¼ 2: MLA (ç®€æ˜“ç‰ˆ)
function toMLA(data) {
    let str = "";
    data.forEach(e => {
        const f = e.fields;
        const authors = (f.author || "").split(" and ");
        let authStr = "";
        
        // ä½œè€…å¤„ç†
        if (authors.length === 1) {
            let p = parseName(authors[0]);
            authStr = `${p.last}, ${p.first}.`;
        } else if (authors.length === 2) {
            let p1 = parseName(authors[0]);
            let p2 = parseName(authors[1]);
            authStr = `${p1.last}, ${p1.first}, and ${p2.first} ${p2.last}.`;
        } else if (authors.length > 2) {
            let p = parseName(authors[0]);
            authStr = `${p.last}, ${p.first}, et al.`;
        }
        
        // æ ‡é¢˜å»é™¤èŠ±æ‹¬å·
        let title = (f.title || "").replace(/[\{\}]/g, "");
        
        // æ¥æº (ä¼šè®®/æœŸåˆŠ)
        let container = f.booktitle || f.journal || "";
        
        // ç»†èŠ‚
        let details = [];
        if (f.volume) details.push(`vol. ${f.volume}`);
        if (f.number) details.push(`no. ${f.number}`);
        if (f.year) details.push(f.year);
        if (f.pages) details.push(`pp. ${f.pages.replace('--', '-')}`);
        
        str += `${authStr} "${title}." ${container}, ${details.join(", ")}.\n\n`;
    });
    return str;
}

// æ ¼å¼ 3: GB/T 7714-2015 (ç®€æ˜“ç‰ˆ)
function toGBT(data) {
    let str = "";
    data.forEach((e, index) => {
        const f = e.fields;
        
        // ä½œè€…: å§“å‰ååï¼Œå§“å…¨å¤§å†™ï¼Œåé¦–å­—æ¯
        const authors = (f.author || "").split(" and ");
        let authList = authors.slice(0, 3).map(name => {
            let p = parseName(name);
            return `${p.last.toUpperCase()} ${p.first.charAt(0)}`;
        });
        if (authors.length > 3) authList.push("et al"); // ä¸­æ–‡å¯ç”¨ "ç­‰"
        let authStr = authList.join(", ");
        
        // æ ‡é¢˜
        let title = (f.title || "").replace(/[\{\}]/g, "");
        
        // æ–‡çŒ®ç±»å‹æ ‡è¯† [J]æœŸåˆŠ, [C]ä¼šè®®, [M]ä¹¦
        let type = "[C]"; 
        if (e.type.toLowerCase().includes("article")) type = "[J]";
        else if (e.type.toLowerCase().includes("book")) type = "[M]";
        
        // æ¥æº
        let venue = f.booktitle || f.journal || "";
        
        // å¹´å·æœŸé¡µ
        let year = f.year || "";
        let vol = f.volume || "";
        let no = f.number ? `(${f.number})` : "";
        let pages = f.pages ? `: ${f.pages.replace('--', '-')}` : "";
        
        let pubInfo = year;
        if (vol) pubInfo += `, ${vol}${no}`;
        pubInfo += pages;
        
        str += `[${index+1}] ${authStr}. ${title}${type}. ${venue}, ${pubInfo}.\n`;
    });
    return str;
}

// è¾…åŠ©: è§£æåå­— (Last, First æˆ– First Last)
function parseName(raw) {
    raw = raw.trim();
    if (raw.includes(',')) {
        let parts = raw.split(',');
        return { last: parts[0].trim(), first: parts[1].trim() };
    } else {
        let parts = raw.split(' ');
        let last = parts.pop();
        let first = parts.join(' ');
        return { last, first };
    }
}

function copyResult() {
    const output = document.getElementById('output');
    output.select();
    document.execCommand('copy');
    const toast = document.getElementById('toast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>

</body>
</html>